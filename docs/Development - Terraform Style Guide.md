# Terraform Style Guide

This guide provides the standards and best practices for developing Terraform modules at CLOUDETEER. It is designed to ensure clarity, readability, and consistency across all Terraform projects. These are recommendations to be followed as much as possible.

## Starting point

We adhere to the [Terraform Official Style Guide](https://developer.hashicorp.com/terraform/language/style) and augment it with the following conventions.

Use `terraform fmt` to enforce consistent formatting.

## General Formatting

### 120 column limit

Set a line length limit of **120 characters**. _Exception_: Single-line description strings in variables and output blocks.

### Empty line between blocks

Separate each HCL block with one empty line between to make readability better.

### Snake Case

The label for blocks should be in snake case. E.g. `example_instance` , not `ExampleInstance` or `example-instance`.

### Descriptive names

Use descriptive names for block labels and variable and output names and avoid abbreviations whenever possible.

## Module Directory Structure

### Required Directories

Each module repository must include the following directory structure:

- **`examples/`**  
  All module examples are placed here. Each example should define at least one `main.tf` and one `README.md` file. The `examples/usage/' example is required, other examples are optional, see [Examples](#examples).

- **`examples/usage/`**  
  Contains a fully functional example demonstrating how to use the module. This example should serve as a reference implementation, showcasing all key features and expected usage patterns of the module.

- **`tests/examples/`**  
  Contains test files that validate the examples in the `examples/` folder. For instance, if the main example is `usage`, the corresponding test should be named `usage.tftest.hcl`. These tests ensure that the examples remain functional as changes are made to the module.

- **`tests/local/`**  
  Contains local unit tests for the module, typically run during development. Tests can be stored in a single `main.tftest.hcl` file or split into multiple files for better organization. These tests should mock external dependencies, allowing for quick feedback without requiring actual infrastructure.

- **`tests/remote/`**  
  Contains tests that perform real deployments using actual cloud providers. These tests are designed to run in CI pipelines (e.g., on pull requests) and validate the module’s functionality in a fully deployed environment. Remote tests ensure that the module works as expected in production-like scenarios.

### File Structure

Each module repository must include the following Terraform files:

- **`terraform.tf`**  
  Contains a single [`terraform`](https://developer.hashicorp.com/terraform/language/terraform#terraform) block specifying the module's [`required_version`](https://developer.hashicorp.com/terraform/language/terraform#terraform-required_version) of Terraform and [`required_providers`](https://developer.hashicorp.com/terraform/language/terraform#terraform-required_providers). This ensures compatibility and enforces consistent versions across environments.

- **`variables.tf`**  
  Defines all input variables for the module. This file organizes and documents the inputs needed to configure the module effectively, see [Variables](#variables).

- **`outputs.tf`**  
  Contains the module's output definitions. All values that the module returns for external use must be defined here to ensure clarity and usability, see [Outputs](#outputs).

- **`main.tf`**  
  For simple modules, all core logic should be placed in this file.
  For more complex modules:

  - **Resources**: Group and organize resource blocks into separate files with meaningful and intuitive names, prefixed with `r-`. Example: `r-network.tf`.
  - **Data sources**: Similarly, organize data source blocks into separate files with meaningful names, prefixed with `d-`. Example: `d-identity.tf`.

- **`README.md`**  
  The complete module documentation with autogenerated content, see [documentation](#documentation).

- **`LICENSE`**  
  All public modules must include a valid `LICENSE` file. The default license for CLOUDETEER is [MIT](https://opensource.org/license/mit).

### Additional Configuration files

Read the [CONTRIBUTING](../CONTRIBUTING.md) guide for details about additional tools and configuration files outside the Terraform scope, but required for CLOUDETEER Terraform modules.

## Resources and Data Sources

### Names

Use descriptive names. If there’s only one resource, use `this`. For example, in an Azure Virtual Network, use `azurerm_virtual_network.this` and descriptive names like `private`, `public`, or `database` for multiple instances of `azurerm_subnet`.

Always use singular nouns for names.

### Tags

Include `tags` (if applicable) as the last argument, followed by `depends_on` and `lifecycle`. Separate these with an empty line.

### `ignore_changes`

If [`ignore_changes`](https://developer.hashicorp.com/terraform/language/meta-arguments/lifecycle#ignore_changes) is used, each ignored attribute must be preceded by a comment explaining why it is being ignored.

### Conditionals

Simple [conditionals](https://developer.hashicorp.com/terraform/language/expressions/conditionals) may be written into a single line.

```hcl
locals {
  environment_tag = var.environment == "prod" ? "production" : "development"
}
```

Use `()` to break up complex conditionals across multiple lines.

```hcl
# ❌ BAD
locals {
  environment_tag = local.environment == "prod" ? "production" : local.environment == "staging" ? "staging" :"development"
}

# ✅ GOOD
locals {
  environment_tag = (
    local.environment == "prod"
    ? "production"
    : local.environment == "staging" ? "staging" : "development"
  )
}
```

### Dynamic blocks

When using a [dynamic block](https://developer.hashicorp.com/terraform/language/expressions/dynamic-blocks) to create conditional blocks, use a list with a single `true` element for the true case and an empty list for the false case.

```hcl
# ❌ BAD
dynamic {
  for_each = var.test ? [null] : []
  # this block does the same but reading null is unclear
}

# ✅ GOOD
dynamic {
  for_each = var.test ? [true] : []
}
```

## Variables

### Follow argument names

Do not create custom names for variables where standard arguments already exist. Follow the argument names from the resource's "Argument Reference".

If necessary, prefix the variable name with the resource name where the variable is used, followed by the resource's attribute name. For example, if you have a module that defines an [`azurerm_virtual_network`](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/virtual_network) and an [`azurerm_subnet`](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/subnet), and the IP address ranges are assigned via variables, use `virtual_network_address_space` and `subnet_address_prefixes` as variable names, instead of `address_space` and `address_prefixes`.

### Variable Lists and Maps

For variables of type `list(...)` and `map(...)`, use plural form in the variable name.

### Sort Variables Alphabetically

Alphabetically sort variables in the `variables.tf` file. Use [tfsort](https://github.com/AlexNabokikh/tfsort) for assistance.

### Complex Variables

- Complex types should use concrete objects (`object` type) over free-form `map` types.
- Multiline descriptions for complex variables should describe each key in a Markdown table in the variable description.
- Use [Heredoc String](https://developer.hashicorp.com/terraform/language/expressions/strings#heredoc-strings) for multiline string in variable description field.

## Outputs

### Follow attribute names

Do not create custom names for outputs where standard attributes of resources already exist. Follow the attribute names from the resource's "Attributes Reference".

Outputs must be meaningful and intuitive even when used outside the module.

### Output Lists and Maps

For the output type is `list` or `map`, the name must be plural.

### Sort Outputs Alphabetically

Alphabetically sort variables in the `variables.tf` file. Use [tfsort](https://github.com/AlexNabokikh/tfsort) for assistance.

## Documentation

### `README.md`

#### Document title

The **h1 title** of the `README.md` must match the repository name, e.g., `# terraform-azurerm-vm`. Directly below the title, provide a concise and informative description of the module’s purpose and functionality.

#### `terraform-docs`

Use `terraform-docs` to automatically generate documentation for your module. Insert the comments `<!-- BEGIN_TF_DOCS -->` and `<!-- END_TF_DOCS -->` to define where the autogenerated content will appear. This should follow the initial module description to ensure a clean and structured layout.

Ensure the `.terraform-docs.yaml` configuration file is consistent with the [global configuration](../terraform-docs.yaml) used in CI tests. This guarantees uniform documentation output across all modules and prevents discrepancies during CI validation.

#### Absolute URLs

**All links** within the `README.md` must be absolute URLs (e.g., full URLs starting with `https://`) to ensure that they render correctly on the Terraform Registry website.

#### Public Module Header

For public modules, add this header to the `README.md`, above the h1 title:

```markdown
<!-- markdownlint-disable first-line-h1 no-inline-html -->

> [!NOTE]
> This repository is publicly accessible as part of our open-source initiative. We welcome contributions from the community alongside our organization's primary development efforts.

---
```

### Examples

#### Mandatory usage example

Every module must include at least one example in `./examples/usage/main.tf` and provide a description in `./examples/usage/main.md`.

#### Test examples

Ensure that examples are tested with corresponding tests located in `./tests/examples/`.

All examples should include `test_override.tf`, specifying [`required_version`](https://developer.hashicorp.com/terraform/language/terraform#terraform-required_version) and overriding the `source` to `../..` to ensure testing uses the current codebase.

## Testing

There are three levels of testing:

1. Example tests in `./tests/examples/`
2. Local tests in `./tests/local/`
3. Remote tests in `./tests/remote/`

### Naming Conventions

- Test files should be named `main.tftest.hcl` unless split into multiple files.
- Labels within `run {}` blocks must clearly describe the test, using `should` or `expect` (e.g., `should_fail_with_no_subnet_id`).

### Explicit `command`

Always define the `command` in a `run {}` block, even if you intend to use the default `apply` command.

### Mock Providers

Use `mock_provider`s for "example" and "local" tests only. All tests must be runnable without an active session on any cloud provider.

### Mock Provider Data

Mocks must be stored in `tests/mocks/` or `.tests/{examples,local,remote}/mocks/`. Each mock should be defined in its own file, named after the resource being mocked. If there are few mocks, it's acceptable to store them in a single `main.tfmock.hcl` file, where blocks should be ordered alphabetically first by block type, then by block label.

### Mocking UUIDs

When [mocking](https://developer.hashicorp.com/terraform/language/tests/mocking) UUIDs, always use `00000000-0000-0000-0000-000000000000` as the mock value to make it clear in the `terraform` command output that this is a mocked value.

### Remote Tests

Tests in `./tests/remote/` execute real deployments using actual providers—no mock providers are allowed. Sensitive information (e.g., `subscription_id` for Azure) must be passed via environment variables and must not be hardcoded into the module tests.
